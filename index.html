<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>姿勢チェックミニゲーム</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0"></script>
<!-- MediaPipe Pose -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>

<style>
body{font-family:system-ui,Arial;margin:0;background:#f9fbff;color:#0f172a;}
h1{text-align:center;color:#2563eb;margin:16px 0;}
#layout{display:flex;justify-content:center;align-items:flex-start;gap:30px;flex-wrap:wrap;margin-top:20px;}
#videoWrap{position:relative;}
video,canvas{border:1px solid #cbd5e1;border-radius:8px;}
#info{width:300px;}
#jellyImg{width:100%;border-radius:8px;margin-top:10px;}
button{margin-top:10px;padding:10px 20px;border:none;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer;}
button:disabled{background:#94a3b8;}
#label{font-size:20px;font-weight:bold;margin-top:10px;}
#hint{color:#64748b;margin-top:5px;}
</style>
</head>

<body>
<h1>姿勢チェックミニゲーム</h1>
<div id="layout">
  <div id="videoWrap">
    <video id="webcam" autoplay playsinline muted width="640" height="480"></video>
    <canvas id="overlay" width="640" height="480"></canvas>
  </div>
  <div id="info">
    <div id="label">モデル準備中...</div>
    <div id="hint">「開始」ボタンを押して計測を開始します。</div>
    <img id="jellyImg" src="背景水母.png" alt="jellyfish">
    <button id="btnStart">開始</button>
    <button id="btnStop" disabled>終了</button>
  </div>
</div>

<script>
const MODEL_URL = "./model/model.json";
const labels=["背景","正しい姿勢","猫背","椅子にもたれる"];
let model=null,running=false;
let counts={correct:0,incorrect:0,total:0};
let bubbles=new Audio("bubbles.wav"),wave=new Audio("ocean wave.wav");
let currentSound=null;

const video=document.getElementById("webcam");
const overlay=document.getElementById("overlay");
const octx=overlay.getContext("2d");
const labelEl=document.getElementById("label");
const jelly=document.getElementById("jellyImg");
const btnStart=document.getElementById("btnStart");
const btnStop=document.getElementById("btnStop");

async function initCamera(){
  const stream=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480}});
  video.srcObject=stream;await video.play();
  console.log("✅ カメラ起動完了");
}

async function loadModel(){
  model=await tf.loadLayersModel(MODEL_URL);
  labelEl.textContent="✅ モデル読み込み完了";
}

const pose=new Pose({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
pose.setOptions({modelComplexity:1,smoothLandmarks:true,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
pose.onResults(onPoseResults);

async function detectLoop(){
  if(!running)return;
  await pose.send({image:video});
  requestAnimationFrame(detectLoop);
}

function onPoseResults(results){
  octx.clearRect(0,0,640,480);
  octx.drawImage(results.image,0,0,640,480);
  if(!results.poseLandmarks||!model)return;

  const inputs=[];results.poseLandmarks.forEach(p=>inputs.push(p.x,p.y,p.z,p.visibility));
  const tensor=tf.tensor([inputs]);
  const preds=model.predict(tensor);
  preds.array().then(arr=>{
    const probs=arr[0];
    const maxIdx=probs.indexOf(Math.max(...probs));
    const label=labels[maxIdx];
    const prob=(probs[maxIdx]*100).toFixed(1);
    labelEl.textContent=`${label} (${prob}%)`;

    // 更新統計
    counts.total++;
    if(label==="正しい姿勢"){counts.correct++;playSound(bubbles,"正しい姿勢");jelly.src="正しい姿勢水母.png";}
    else if(label==="猫背"||label==="椅子にもたれる"){counts.incorrect++;playSound(wave,"誤り姿勢");jelly.src=label==="猫背"?"猫背水母.png":"椅子にもたれる水母.png";}
    else{jelly.src="背景水母.png";}

    tf.dispose([tensor,preds]);
  });
}

function playSound(sound,label){
  if(currentSound && !currentSound.paused && currentSound!==sound){
    currentSound.pause();
    currentSound.currentTime=0;
  }
  currentSound=sound;
  if(currentSound.paused)currentSound.play();
}

btnStart.onclick=async()=>{
  await loadModel();
  await initCamera();
  running=true;
  btnStart.disabled=true;
  btnStop.disabled=false;
  detectLoop();
};

btnStop.onclick=()=>{
  running=false;
  btnStart.disabled=false;
  btnStop.disabled=true;
  localStorage.setItem("poseStats",JSON.stringify(counts));
  window.location.href="stats.html";
};
</script>
</body>
</html>
