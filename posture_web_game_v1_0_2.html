<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>姿勢チェックミニム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />


  <style>
    :root {
      --blue: #2b6cb0;
      --blue-soft: #e6f0ff;
      --border: #bcd3ff;
      --ok: #2f855a;
      --warn: #c53030;
      --text: #0a2540;
      --muted: #64748b;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: #fff;
      color: var(--text)
    }

    header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border)
    }

    header h1 {
      margin: 0;
      color: var(--blue);
      font-size: 20px
    }

    .container {
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 20px
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 4px 14px rgba(0, 0, 0, .05);
      padding: 16px
    }

    #grid {
      display: grid;
      gap: 16px;
      grid-template-columns: 2fr 1fr
    }

    #videoWrap {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--blue-soft);
      overflow: hidden;
      min-height: 480px
    }

    #webcam {
      display: block;
      width: 640px;
      height: 480px
    }

    #overlay {
      position: absolute;
      left: 0;
      top: 0;
      width: 640px;
      height: 480px;
      pointer-events: none
    }

    #rightPane {
      display: flex;
      flex-direction: column;
      gap: 12px
    }

    .panel {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px
    }

    .panel h3 {
      margin: 0 0 8px 0;
      color: var(--blue);
      font-size: 15px
    }

    #jelly {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px
    }

    #jelly img {
      width: 180px;
      height: auto;
      user-select: none
    }

    #statusText {
      font-weight: 700
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap
    }

    button {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      border-radius: 10px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 700
    }

    button.primary {
      background: var(--blue);
      color: #fff;
      border-color: var(--blue)
    }

    button.gray {
      background: #475569;
      color: #fff;
      border-color: #475569
    }

    .sound.on {
      background: #e9f5ff;
      border-color: #8ab0ff
    }

    #report {
      display: none
    }

    #reportGrid {
      display: grid;
      gap: 16px;
      grid-template-columns: 1.2fr 1fr
    }

    #pieWrap {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 420px
    }

    #details {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px
    }

    .stat {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px dashed #e5e7eb
    }

    .stat:last-child {
      border-bottom: none
    }

    .muted {
      color: var(--muted)
    }

    @media(max-width:900px) {

      #grid,
      #reportGrid {
        grid-template-columns: 1fr
      }
    }
  </style>
</head>

<body>
  <header class="container">
    <h1>姿勢チェックゲーム</h1>
  </header>

  <main class="container">
    <!-- 实时识别页 -->
    <section id="app" class="card">
      <div id="grid">
        <!-- 左侧：摄像头 + 骨架叠加 -->
        <div id="videoWrap">
          <video id="webcam" autoplay playsinline muted width="640" height="480"></video>
          <canvas id="canvas" width="640" height="480"></canvas>
          <div id="label-container"></div>
        </div>


        <!-- 右侧：水母 + 控制 + 状态 -->
        <div id="rightPane">
          <div class="panel" id="jelly">
            <h3>フィードバック</h3>
            <img id="jellyImg" src="背景水母.png" alt="jellyfish" />
            <div id="statusText" class="muted">未開始</div>
            <div id="hintText" class="muted">「開始」を押して計測を始めます。</div>
          </div>

          <div class="panel">
            <h3>コントロール</h3>
            <div class="controls">
              <button id="btnStart" class="primary">開始</button>
              <button id="btnStop" class="gray" disabled>終了</button>
              <button id="btnSound" class="sound on">音声 ON</button>
            </div>
          </div>

          <div class="panel">
            <h3>ステータス</h3>
            <div>サンプル数：<span id="sampleCount">0</span></div>
            <div>現在：<span id="currentLabel">-</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 统计报告页 -->
    <section id="report" class="card">
      <h3 style="color:var(--blue);margin-top:0;">レポート</h3>
      <div id="reportGrid">
        <div id="pieWrap"><canvas id="pie" width="420" height="420"></canvas></div>
        <div id="details">
          <div class="stat"><span>正しい姿勢</span><strong id="statGood">0</strong></div>
          <div class="stat"><span>猫背（前のめり）</span><strong id="statForward">0</strong></div>
          <div class="stat"><span>椅子にもたれる（後傾）</span><strong id="statLean">0</strong></div>
          <div class="stat"><span>合計</span><strong id="statTotal">0</strong></div>
          <div class="stat"><span>正しい姿勢率</span><strong id="statRate">0%</strong></div>
          <div style="margin-top:10px;">
            <button id="btnBack" class="primary">戻る</button>
          </div>
          <p class="muted" style="margin-top:10px;">※ このページは「終了」を押した後に表示されます。</p>
        </div>
      </div>
    </section>
  </main>

  <!-- 音效 -->
  <audio id="sndBubbles" src="bubbles.wav" preload="auto"></audio>
  <audio id="sndOcean" src="ocean wave.wav" preload="auto"></audio>
  <!-- MediaPipe Pose -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8.3/dist/teachablemachine-pose.min.js"></script>
  <script type="text/javascript">
    // More API functions here:
    // https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/pose

    // the link to your model provided by Teachable Machine export panel
    const URL = "https://teachablemachine.withgoogle.com/models/8xBjr0v_2/";
    //const URL = "./my_model/";
    let model, webcam, ctx, labelContainer, maxPredictions;

    /* ===== 配置与状态 ===== */
    let running = false;
    let soundOn = true;
    let currentGroup = "idle";

    const video = document.getElementById("webcam");
    const canvas = document.getElementById("canvas");

    const jellyImg = document.getElementById("jellyImg");
    const statusText = document.getElementById("statusText");
    const hintText = document.getElementById("hintText");
    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const btnSound = document.getElementById("btnSound");
    const btnBack = document.getElementById("btnBack");

    const labelNow = document.getElementById("currentLabel");
    const sampleCountEl = document.getElementById("sampleCount");

    const sndBubbles = document.getElementById("sndBubbles");
    const sndOcean = document.getElementById("sndOcean");

    const appView = document.getElementById("app");
    const reportView = document.getElementById("report");
    const statGood = document.getElementById("statGood");
    const statForward = document.getElementById("statForward");
    const statLean = document.getElementById("statLean");
    const statTotal = document.getElementById("statTotal");
    const statRate = document.getElementById("statRate");
    const pieCanvas = document.getElementById("pie");

    let counts = { good: 0, forward: 0, lean: 0, total: 0 };

    async function init() {

      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      // load the model and metadata
      // Refer to tmImage.loadFromFiles() in the API to support files from a file picker
      // Note: the pose library adds a tmPose object to your window (window.tmPose)
      model = await tmPose.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      // Convenience function to setup a webcam
      //const size = 200;
      const width = 640;
      const height = 480;
      const flip = true; // whether to flip the webcam
      webcam = new tmPose.Webcam(width, height, flip); // width, height, flip
      await webcam.setup(); // request access to the webcam
      await webcam.play();

      // append/get elements to the DOM
      const canvas = document.getElementById("canvas");
      canvas.width = width; canvas.height = height;
      ctx = canvas.getContext("2d");
      labelContainer = document.getElementById("label-container");
      for (let i = 0; i < maxPredictions; i++) { // and class labels
        labelContainer.appendChild(document.createElement("div"));
      }
    }
    const CLASS_MAP = {
      "Class 1": "idle",     // 背景
      "Class 2": "good",     // 正姿势
      "Class 3": "forward",  // 猫背
      "Class 4": "lean"      // 后仰依靠
    };

    /*
         ===== 初始化 TM 模型 ===== 
    async function init() {
      const size = 200;
      const flip = true;

      webcam = new tmPose.Webcam(size, size, flip);
      await webcam.setup();
      await webcam.play();

      window.requestAnimationFrame(loop);
    }
    */

    /*
    async function loop() {
      if (!running) return;  // ❗ 停止按钮会把 running 设置为 false
      webcam.update();
      await predict();
      requestAnimationFrame(loop);
    }
    */

    function switchGroup(group) {
      if (currentGroup === group) return;
      currentGroup = group;

      if (group === "good") {
        jellyImg.src = "正しい姿勢水母.png";
        statusText.textContent = "Good!";
        statusText.style.color = "#2f855a";
        hintText.textContent = "ナイス！その姿勢をキープ";
        if (soundOn) { sndBubbles.pause(); sndBubbles.currentTime = 0; sndBubbles.play(); }

      } else if (group === "forward") {
        jellyImg.src = "猫背水母.png";
        statusText.textContent = "猫背（前のめり）";
        statusText.style.color = "#c53030";
        hintText.textContent = "胸を開き、肩を下げましょう";
        if (soundOn) { sndOcean.pause(); sndOcean.currentTime = 0; sndOcean.play(); }

      } else if (group === "lean") {
        jellyImg.src = "椅子にもたれる水母.png";
        statusText.textContent = "椅子にもたれる（後傾）";
        statusText.style.color = "#c53030";
        hintText.textContent = "背もたれから少し離れます";
        if (soundOn) { sndOcean.pause(); sndOcean.currentTime = 0; sndOcean.play(); }

      } else {
        jellyImg.src = "背景水母.png";
        statusText.textContent = "未開始";
        statusText.style.color = "#64748b";
        hintText.textContent = "「開始」を押して計測を始めます。";
      }
    }

    async function predict() {
      const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);

      // 1. 获取 TM 分类结果
      const prediction = await model.predict(posenetOutput);

      // 2. 找到概率最高的类别
      let best = prediction[0];
      for (let p of prediction) {
        if (p.probability > best.probability) best = p;
      }

      // 3. TM className → 转换为 UI 的 group
      const group = CLASS_MAP[best.className] || "idle";

      // 4. 应用 UI 逻辑
      switchGroup(group);
      labelNow.textContent = best.className; // 显示原始类别

      // 5. 统计计数（防止 idle 计数）
      if (group !== "idle") {
        counts.total++;
        if (group === "good") counts.good++;
        else if (group === "forward") counts.forward++;
        else if (group === "lean") counts.lean++;

        sampleCountEl.textContent = counts.total;
      }

      // 6. 画骨架（TM 自带）
      drawPose(pose);
    }

    function drawPose(pose) {
      if (webcam.canvas) {
        ctx.drawImage(webcam.canvas, 0, 0);
        // draw the keypoints and skeleton
        if (pose) {
          const minPartConfidence = 0.5;
          tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
          tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
        }
      }
    }


    /* ===== loop (TM Pose 主循环) ===== */
    async function loop() {
      if (!running) return;  // 停止时跳出循环
      webcam.update();
      await predict();
      requestAnimationFrame(loop);
    }

    async function detectLoop() {
      if (!running) return;
      webcam.update();
      await predict();
      //await pose.send({ image: video });
      requestAnimationFrame(loop);
    }

    /* ===== 开始按钮 ===== */
    btnStart.onclick = async () => {
      if (running) return;

      await init();  // 启动 TM 模型 + 摄像头
      running = true;
      btnStart.disabled = true;
      btnStop.disabled = false;

      detectLoop();
    };

    /* ===== 停止按钮 ===== */
    btnStop.onclick = () => {
      running = false;
      btnStart.disabled = false;
      btnStop.disabled = true;

      // 停止 TM 摄像头
      if (webcam && webcam.stream) {
        webcam.stream.getTracks().forEach(t => t.stop());
      }

      // 清空画面
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 关闭后显示统计页
      showReport();
    };


    btnSound.onclick = () => {
      soundOn = !soundOn;
      btnSound.textContent = soundOn ? "音声 ON" : "音声 OFF";
      btnSound.classList.toggle("on", soundOn);
    };

    btnBack.onclick = () => {
      // 重置统计
      counts = { good: 0, forward: 0, lean: 0, total: 0 };
      sampleCountEl.textContent = "0";
      labelNow.textContent = "-";
      switchGroup("idle");

      // 切回实时页
      reportView.style.display = "none";
      appView.style.display = "block";
    };

    /* ===== 统计页：饼图 ===== */
    function showReport() {
      const total = Math.max(1, counts.total);
      const goodRate = Math.round((counts.good / total) * 100);

      statGood.textContent = counts.good;
      statForward.textContent = counts.forward;
      statLean.textContent = counts.lean;
      statTotal.textContent = counts.total;
      statRate.textContent = goodRate + "%";

      const ctx = pieCanvas.getContext("2d");
      ctx.clearRect(0, 0, pieCanvas.width, pieCanvas.height);

      const data = [
        { label: "正しい", value: counts.good, color: "#77aaff" },
        { label: "猫背", value: counts.forward, color: "#bcd3ff" },
        { label: "寄りかかり", value: counts.lean, color: "#dbe8ff" },
      ];
      const sum = Math.max(1, data.reduce((s, d) => s + d.value, 0));
      let start = -Math.PI / 2;
      const cx = pieCanvas.width / 2, cy = pieCanvas.height / 2, r = 150;

      data.forEach(d => {
        const angle = (d.value / sum) * Math.PI * 2;
        ctx.beginPath(); ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, start, start + angle); ctx.closePath();
        ctx.fillStyle = d.color; ctx.fill();
        start += angle;
      });

      ctx.fillStyle = "#334155";
      ctx.font = "14px system-ui";
      ctx.fillText(`正しい: ${counts.good}`, cx - r, cy + r + 20);
      ctx.fillText(`猫背: ${counts.forward}`, cx - r + 140, cy + r + 20);
      ctx.fillText(`寄りかかり: ${counts.lean}`, cx - r + 260, cy + r + 20);

      appView.style.display = "none";
      reportView.style.display = "block";
    }
  </script>
</body>

</html>