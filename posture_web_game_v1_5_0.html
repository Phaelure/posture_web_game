<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#131F24">

  <title>PostureLens - Smart Core</title>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800;900&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Base Colors */
      --duo-bg:#131F24; --duo-card:#202F36; --duo-text:#fff; 
      --duo-text-muted:#8FA1AA; 
      
      /* Accents */
      --brand:#58CC02; --brand-shade:#46A302;
      --gold:#FFD900; --gold-shade:#D9B800;
      --err:#FF4B4B; --err-shade:#D94040;
      --blue:#1CB0F6; --blue-shade:#1899D6;
      
      /* UI Elements - Scaled Down */
      --gray-btn:#37464F; --gray-btn-shade:#28333A;
      --radius-l:18px; --radius-m:14px; /* Reduced Radius */
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{
      margin:0; font-family:'Nunito', sans-serif;
      background:var(--duo-bg); color:var(--duo-text);
      overflow-x:hidden; font-weight:700;
      transition: box-shadow 0.1s;
    }

    /* Subtle warning flash */
    @keyframes flashRed{
      0%{ box-shadow: inset 0 0 0 0 transparent; }
      50%{ box-shadow: inset 0 0 50px 20px var(--err); }
      100%{ box-shadow: inset 0 0 0 0 transparent; }
    }
    .screen-flash{ animation: flashRed 0.6s ease-out; }

    /* Reduced Layout Width (~10% smaller) */
    .wrap{ max-width:800px; margin:0 auto; padding:12px; position:relative; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    /* ===== TOP BAR STYLES (Ultra Compact & Reordered) ===== */
    .topbar{
      display:flex; gap:10px; margin-bottom:12px;
    }
    .topcard{
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      padding:10px 14px;
      box-shadow:0 3px 0 rgba(0,0,0,0.35);
      transition: transform 0.1s, background 0.2s;
    }
    .topcard:active{ transform: translateY(2px); box-shadow:none; }

    .topcard.goal{ flex:1; cursor:pointer; display: flex; flex-direction: column; justify-content: center; }
    .topcard.report{ display:flex; align-items:center; gap:6px; cursor:pointer; flex:0 0 auto; }

    /* New Goal Layout: All Text Top */
    .goal-top-row{
      display:flex; justify-content:space-between; align-items:baseline;
      margin-bottom:6px;
      font-size:11px; color:var(--duo-text-muted); font-weight:900;
    }
    .goal-left{ display:flex; gap:12px; align-items:baseline; }
    .goal-right{ display:flex; gap:6px; align-items:baseline; }

    .goal-item strong{ color:#fff; }
    .val-blue{
      color:var(--blue); 
      font-size:15px;
      font-family:'Roboto Mono', monospace;
    }
    
    /* Progress Bar */
    .goalbar{
      height:5px;
      background:rgba(255,255,255,0.08);
      border-radius:999px; overflow:hidden;
    }
    .goalbar-fill{
      height:100%; width:0%; background:var(--blue);
      transition:width .5s cubic-bezier(0.34, 1.56, 0.64, 1), background .3s;
    }
    
    /* Achieved State */
    .goal-achieved .goalbar-fill{ background:var(--brand); box-shadow: 0 0 10px var(--brand); }
    .goal-achieved{
      border-color:rgba(88,204,2,0.35);
      background:rgba(88,204,2,0.05);
      box-shadow:0 3px 0 rgba(0,0,0,0.35), 0 0 20px rgba(88,204,2,0.1);
    }
    
    .report-arrow{
      width:7px; height:7px;
      border-right:2px solid #fff; border-top:2px solid #fff; 
      transform:rotate(45deg); margin-left:2px;
    }
    .topcard.report span { font-size: 12px; font-weight: 800; }

    /* ===== MAIN CARD & CAMERA (Scaled Padding) ===== */
    .card{
      background:var(--duo-card); border:2px solid rgba(255,255,255,0.1);
      border-radius:var(--radius-l); padding:14px; /* Reduced from 16px */
      margin-bottom:14px;
      margin-top:14px; position:relative;
    }
    .cam{
      position:relative; overflow:hidden; border-radius:var(--radius-m);
      width:100%; aspect-ratio:16/9; background:#000;
      border:3px solid rgba(255,255,255,0.1);
    }
    .cam canvas{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transform:scaleX(-1); }

    .overlay-layer{
      position:absolute; inset:0; display:flex; flex-direction:column;
      align-items:center; justify-content:center; z-index:10;
      background:rgba(19,31,36,0.95); border-radius:var(--radius-m);
      transition:opacity 0.3s; pointer-events:none; opacity:0; text-align:center;
    }
    .overlay-layer.active{ opacity:1; pointer-events:auto; }

    .spinner{
      width:40px; height:40px; border:5px solid var(--gray-btn);
      border-top-color:var(--brand); border-radius:50%;
      animation:spin 1s linear infinite; margin-bottom:12px;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    /* Calibration */
    .calib-ring{
      width:100px; height:100px; border-radius:50%; border:6px solid var(--gray-btn);
      display:flex; align-items:center; justify-content:center;
      margin-bottom:16px; transition:border-color 0.3s;
    }
    .calib-ring.active{ border-color:var(--brand); box-shadow:0 0 30px rgba(88,204,2,0.4); }
    .calib-text{ font-size:16px; color:#fff; max-width:80%; line-height:1.5; }
    .calib-check{ font-size:40px; opacity:0; transform:scale(0.5); transition:0.3s; }
    .calib-check.show{ opacity:1; transform:scale(1); }

    .countdown-text{
      font-size:70px; font-weight:900; color:#fff;
      text-shadow:0 4px 10px rgba(0,0,0,0.5);
      animation:pop 0.5s cubic-bezier(0.175,0.885,0.32,1.275);
    }
    @keyframes pop{ 0%{ transform:scale(0.5); opacity:0; } 100%{ transform:scale(1); opacity:1; } }

    .ctrls{ justify-content:space-between; margin-top:16px; align-items:center; gap:16px; }

    /* Buttons Shared */
    .btn, .pill, .modal-btn{
      border:none; border-radius:var(--radius-m); font-family:inherit; font-weight:800;
      cursor:pointer; transition:all 0.1s; text-transform:uppercase; letter-spacing:0.5px;
      position:relative; top:0; white-space:nowrap; outline:none;
    }
    .btn:active:not(:disabled), .pill:active, .modal-btn:active{ top:4px; box-shadow:none !important; }

    /* Control Buttons (Smaller) */
    .btn{
      padding:10px 20px; color:#fff; background:var(--brand);
      box-shadow:0 4px 0 var(--brand-shade); min-height:44px; font-size:15px;
    }
    .btn:disabled{
      background:var(--gray-btn); color:var(--duo-text-muted);
      box-shadow:0 4px 0 var(--gray-btn-shade);
      cursor:not-allowed; opacity:0.8;
    }
    .btn.ghost{ background:var(--err); box-shadow:0 4px 0 var(--err-shade); }
    .btn.ghost:disabled{ background:var(--gray-btn); box-shadow:0 4px 0 var(--gray-btn-shade); color:var(--duo-text-muted); }

    /* Toggles & Duration Pills */
    .toggle{ display:flex; align-items:center; gap:6px; font-weight:800; font-size: 14px; }
    .toggle input{
      appearance:none; width:40px; height:22px; border-radius:999px;
      background:var(--gray-btn); position:relative; outline:none; transition:.2s;
      border:2px solid var(--duo-bg); cursor:pointer;
    }
    .toggle input:checked{ background:var(--brand); }
    .toggle input::after{
      content:""; position:absolute; top:2px; left:2px; width:14px; height:14px;
      border-radius:50%; background:#fff; transition:.2s;
      box-shadow:0 2px 4px rgba(0,0,0,0.2);
    }
    .toggle input:checked::after{ left:20px; }

    .timer-text{
      font-family:'Roboto Mono', monospace; font-weight:700; font-size:20px; color:#fff;
      background:linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border:1px solid rgba(255,255,255,0.15); border-radius:10px; padding:4px 14px;
      text-shadow:0 0 12px rgba(255,255,255,0.4);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.1), 0 4px 10px rgba(0,0,0,0.3);
      letter-spacing:1px; display:inline-block; min-width:80px; text-align:center;
    }

    .pill{
      padding:6px 10px; background:var(--gray-btn); color:var(--duo-text);
      box-shadow:0 3px 0 var(--gray-btn-shade); font-size:12px; border-radius:10px;
    }
    .pill[data-active="1"]{
      background:var(--blue); box-shadow:0 3px 0 var(--blue-shade); color:#fff;
    }

    .game-area{ display:flex; gap:16px; align-items:stretch; justify-content:center; flex-wrap:wrap; margin-top:14px; }

    #jelly-panel{
      flex:0 0 auto; width:220px; height:240px; padding:12px;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      transition:all 0.3s; background:transparent;
      border:3px solid var(--gray-btn); border-radius:var(--radius-l);
    }
    #jelly-panel.bg-good{ border-color:var(--brand); box-shadow:0 0 20px rgba(88,204,2,0.3); }
    #jelly-panel.bg-bad{ border-color:var(--err); box-shadow:0 0 20px rgba(255,75,75,0.3); }
    #jelly-panel.bg-idle{ border-color:var(--gray-btn); }

    #jellyImg{
      width:100%; height:auto; max-height:180px; object-fit:contain; user-select:none;
      filter:drop-shadow(0 4px 0 rgba(0,0,0,0.2));
    }

    /* Live monitor */
    #live-monitor{
      flex:1; min-width:240px; height:240px; padding:16px;
      display:flex; flex-direction:column; align-items:center; justify-content:space-evenly;
      text-align:center; background:var(--duo-card);
      border:2px solid rgba(255,255,255,0.1); border-radius:var(--radius-l);
    }

    .live-label{
      font-size:11px; color:var(--duo-text-muted);
      text-transform:uppercase; letter-spacing:1.5px; font-weight:800;
      margin-top:5px; margin-bottom:0;
    }
    .live-status-big{
      font-size:36px; font-weight:900; line-height:1;
      transition:color 0.2s;
      text-shadow:0 4px 0 rgba(0,0,0,0.2);
      display:inline-block;
      margin:8px 0 16px 0;
    }
    @keyframes float{ 0%,100%{ transform:translateY(0);} 50%{ transform:translateY(-10px);} }
    @keyframes bounceIn{ 0%{ transform:scale(0.3); opacity:0;} 50%{ transform:scale(1.2);} 70%{ transform:scale(0.9);} 100%{ transform:scale(1); opacity:1;} }
    @keyframes shake{ 0%,100%{ transform:translateX(0);} 25%{ transform:translateX(-5px) rotate(-5deg);} 75%{ transform:translateX(5px) rotate(5deg);} }

    .st-idle{ color:var(--duo-text-muted); animation:float 3s ease-in-out infinite; }
    .st-good{ color:var(--brand); animation:bounceIn 0.5s cubic-bezier(0.175,0.885,0.32,1.275); }
    .st-bad{ color:var(--err); animation:shake 0.4s ease-in-out infinite; }

    .live-score-box{
      background:var(--duo-bg); border:3px solid var(--blue);
      padding:10px 20px; border-radius:var(--radius-m);
      font-weight:800; color:var(--blue);
      width:auto; min-width:200px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      font-size:16px; box-shadow:0 4px 0 var(--blue-shade);
      transition:transform 0.1s;
    }
    .live-score-box span{ white-space:nowrap; }

    @keyframes scorePop{
      0%{ transform:scale(1); }
      50%{ transform:scale(1.2); background:#202F36; }
      100%{ transform:scale(1); }
    }
    .score-popping{ animation:scorePop 0.2s ease-out; }

    /* Streak area */
    #combo-area{
      height:30px; display:flex; align-items:baseline; justify-content:center;
      gap:8px; opacity:0; transition:opacity 0.3s; margin-top:8px;
    }
    #combo-area.active{ opacity:1; }
    .combo-num{
      font-size:30px; font-weight:900; color:var(--gold);
      font-style:italic; text-shadow:2px 2px 0 var(--gold-shade);
    }
    .combo-lbl{
      font-size:14px; font-weight:800; color:var(--gold);
      text-transform:uppercase;
    }
    @keyframes comboImpact{
      0%{ transform:scale(1) rotate(0deg); }
      20%{ transform:scale(1.5) rotate(-10deg); text-shadow:0 0 20px var(--gold); }
      40%{ transform:scale(1.5) rotate(10deg); }
      100%{ transform:scale(1) rotate(0deg); }
    }
    .combo-pop{ animation:comboImpact 0.4s ease-out forwards; }

    .hint-text{
      font-size:12px; color:var(--duo-text-muted); font-weight:800;
      margin-top:12px; margin-bottom:4px; opacity:0.8;
    }

    /* ===== MODALS ===== */
    .modal-overlay{
      position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85);
      display:flex; align-items:center; justify-content:center; z-index:9999;
      opacity:0; pointer-events:none; transition:0.3s;
    }
    .modal-overlay.show{ opacity:1; pointer-events:auto; }

    .modal-card{
      background:var(--duo-card); width:90%; max-width:400px; padding:32px 24px;
      border-radius:20px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.5);
      border:3px solid rgba(255,255,255,0.1); transform:scale(0.9); opacity:0;
      transition:all 0.4s cubic-bezier(0.34,1.56,0.64,1); color:var(--duo-text);
      position:relative; overflow:hidden;
    }
    .modal-overlay.show .modal-card{ transform:scale(1); opacity:1; }

    /* Goal Modal Specific */
    #goal-modal .modal-card{
      text-align: left; padding: 20px; max-width: 440px; border-radius: 20px;
    }
    .mini-title{ font-size:20px; font-weight:900; margin-bottom:6px; margin-top:0; }
    .mini-desc{ font-size:13px; color:var(--duo-text-muted); line-height:1.6; font-weight:700; margin-bottom:16px; }

    .target-buttons{
      display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin:16px 0;
    }
    .target-btn{
      padding:12px 0; border:none; border-radius:12px;
      background:var(--gray-btn); box-shadow:0 4px 0 var(--gray-btn-shade);
      color:#fff; font-size:14px; font-weight:900; cursor:pointer;
      transition: transform 0.1s, background 0.2s;
    }
    .target-btn:active{ transform:translateY(4px); box-shadow:none; }
    .target-btn.active{ background:var(--blue); box-shadow:0 4px 0 var(--blue-shade); }

    .slider-label{ font-size:12px; color:var(--duo-text-muted); margin:6px 0; font-weight:800; }
    input[type="range"]{ width:100%; accent-color: var(--blue); margin-bottom: 20px; }

    /* Modal Action Buttons (Generic for Goal Modal) */
    .modal-actions{ display:flex; gap:12px; margin-top:10px; }
    .modal-actions .modal-btn{
      flex:1; padding:12px; font-size:14px; border-radius:14px; 
      width: auto; 
    }
    .modal-btn.cancel{ background:var(--gray-btn); color:#fff; box-shadow:0 4px 0 var(--gray-btn-shade); }
    .modal-btn.save{ background:var(--brand); color:#fff; box-shadow:0 4px 0 var(--brand-shade); }

    /* ===== REWARD & ANALYSIS BUTTONS (SCALED DOWN) ===== */
    .modal-btn {
      width: 100%;
      padding: 10px;
      font-size: 13px;
      border-radius: 12px;
      box-shadow: 0 4px 0 rgba(0,0,0,0.2);
    }
    
    .icon-wrapper{ position:relative; width:100px; height:100px; margin:0 auto 16px auto; }
    .modal-glow-bg{
      position:absolute; top:50%; left:50%; width:160px; height:160px;
      background:radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
      pointer-events:none; z-index:0;
      animation:glowSpin 8s linear infinite;
    }
    .modal-icon{
      font-size:80px; line-height:1; position:relative; z-index:1;
      filter:drop-shadow(0 4px 0 rgba(0,0,0,0.2));
      animation:heartbeat 2s infinite ease-in-out;
    }
    @keyframes heartbeat{
      0%{ transform:scale(1); } 15%{ transform:scale(1.15); } 30%{ transform:scale(1); }
      45%{ transform:scale(1.15); } 100%{ transform:scale(1); }
    }
    @keyframes glowSpin{
      0%{ transform:translate(-50%,-50%) rotate(0deg); opacity:0.5; }
      100%{ transform:translate(-50%,-50%) rotate(360deg); opacity:0.5; }
    }

    .medal-name{ font-size:26px; font-weight:900; margin:0 0 10px 0; letter-spacing:-1px; }
    .lv-master{
      background:linear-gradient(to bottom, #58CC02 0%, #239200 100%);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      filter:drop-shadow(0 2px 0 rgba(0,0,0,0.2));
    }
    .lv-stable{ color:#1CB0F6; text-shadow:0 2px 0 #1185BA; }
    .lv-novice{ color:#FF9600; text-shadow:0 2px 0 #CB7700; }
    .lv-warmup{ color:#AFAFAF; }

    .modal-msg{
      font-size:16px; color:var(--duo-text-muted); margin-bottom:16px;
      font-weight:700; line-height:1.6;
    }
    .reward-summary{ display:flex; gap:10px; margin-bottom:20px; justify-content:center; position:relative; z-index:2; }
    .reward-pill{
      background:var(--duo-bg); border:3px solid; box-shadow:0 4px 0 rgba(0,0,0,0.2);
      padding:8px 14px; border-radius:14px;
      display:flex; flex-direction:column; align-items:center;
      min-width:80px; transition:transform 0.2s;
    }
    .reward-pill:hover{ transform:scale(1.05); }
    .rp-score{ border-color:var(--brand); color:var(--brand); }
    .rp-gem{ border-color:var(--blue); color:var(--blue); }
    .rp-label{ font-size:10px; text-transform:uppercase; font-weight:800; opacity:0.8; margin-bottom:2px; }
    .rp-val{ font-size:20px; font-weight:900; }

    @keyframes btnPulse{
      0%{ box-shadow:0 0 0 0 rgba(88,204,2,0.7); }
      70%{ box-shadow:0 0 0 10px rgba(88,204,2,0); }
      100%{ box-shadow:0 0 0 0 rgba(88,204,2,0); }
    }
    
    .modal-btn.primary{
      background:var(--brand); color:#fff; box-shadow:0 4px 0 var(--brand-shade);
      animation:btnPulse 2s infinite; 
      width: 100%; padding: 10px;
    }
    #close-all-btn{ 
      background:var(--blue); color:#fff; box-shadow:0 4px 0 var(--blue-shade); 
      width: 100%; padding: 10px;
    }

    .modal-title{ font-size:24px; color:var(--duo-text); margin-bottom:20px; font-weight:900; }

    /* Analysis */
    @keyframes slideInUp{ from{ opacity:0; transform:translateY(20px);} to{ opacity:1; transform:translateY(0);} }
    @keyframes shimmer{ 0%{ transform:translateX(-150%);} 100%{ transform:translateX(150%);} }
    .analysis-content{ display:flex; flex-direction:column; align-items:center; gap:20px; width:100%; }
    .analysis-content ul{ width:100%; padding:0; list-style:none; }
    .analysis-content ul li{
      display:flex; justify-content:space-between; align-items:center;
      margin:10px 0; padding:14px;
      background:var(--duo-bg); border-radius:var(--radius-m);
      font-size:14px; font-weight:800;
      border:3px solid transparent; box-shadow:0 4px 0 rgba(0,0,0,0.2);
      opacity:0; position:relative; overflow:hidden;
    }
    .analysis-content ul li.show{ animation:slideInUp 0.5s forwards; }
    .analysis-content ul li::after{
      content:""; position:absolute; top:0; left:0; width:100%; height:100%;
      background:linear-gradient(to right, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
      transform:translateX(-150%);
    }
    .analysis-content ul li.show::after{ animation:shimmer 2s infinite 0.5s; }
    .li-good{ border-color:var(--brand)!important; color:var(--brand); }
    .li-bad{ border-color:var(--gold)!important; color:var(--gold); }
    .li-lean{ border-color:var(--err)!important; color:var(--err); }
    .val-good{ color:var(--brand); } .val-bad{ color:var(--gold); } .val-lean{ color:var(--err); }

    .advice-box{
      background:var(--duo-bg); border:3px solid var(--blue); box-shadow:0 4px 0 var(--blue-shade);
      border-radius:var(--radius-m); padding:16px; width:100%; text-align:left;
    }
    .advice-title{ font-weight:900; color:var(--blue); margin-bottom:8px; display:block; font-size:16px; }
    .advice-text{ font-size:14px; color:var(--duo-text); line-height:1.7; font-weight:700; }

    @media (max-width:600px){
      .game-area{ flex-direction:column; align-items:center; gap:16px; }
      #jelly-panel,#live-monitor{ width:100%; height:auto; padding:20px; min-height:200px; }
      .ctrls{ justify-content:center; }
      .ctrls .row{ justify-content:center; }
      .topbar{ flex-direction:row; } 
      .topcard.goal{ width:auto; }
      .topcard.report{ width:auto; justify-content:center; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div id="goalCard" class="topcard goal">
      
      <div class="goal-top-row">
        <div class="goal-left">
          <div class="goal-item">ÁõÆÊ®ô <strong id="goalTarget">80%</strong></div>
          <div class="goal-item">ÁèæÂú® <span id="currentValue" class="val-blue">0%</span></div>
        </div>
        <div class="goal-right">
          <div class="goal-item">ÈÅîÊàêÂ∫¶ <span id="achieveText">0%</span></div>
        </div>
      </div>

      <div class="goalbar">
        <div id="goalFill" class="goalbar-fill"></div>
      </div>
    </div>

    <div id="reportBtn" class="topcard report">
      <span>„É¨„Éù„Éº„Éà</span>
      <div class="report-arrow"></div>
    </div>
  </div>

  <div class="card">
    <div class="cam">
      <canvas id="overlay"></canvas>

      <div id="calib-overlay" class="overlay-layer">
        <div class="calib-ring" id="calib-ring">
          <div class="calib-check" id="calib-check">‚ú®</div>
        </div>
        <div id="calib-msg" class="calib-text">„Ç´„É°„É©„ÇíË™øÊï¥„Åó„Å¶<br>ËÉåÁ≠ã„Çí‰º∏„Å∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
      </div>

      <div id="loader-overlay" class="overlay-layer">
        <div class="spinner"></div>
        <div>AI„É¢„Éá„É´„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</div>
      </div>

      <div id="countdown-overlay" class="overlay-layer">
        <div id="countdown-text" class="countdown-text">3</div>
      </div>
    </div>

    <div class="row ctrls">
      <div class="row" style="gap:16px">
        <span class="toggle"><label>Èü≥Â£∞</label><input id="t-voice" type="checkbox" checked/></span>
        <span class="toggle"><label>„Ç¨„Ç§„Éâ</label><input id="t-video" type="checkbox" checked/></span>
      </div>

      <div class="row" id="duration" style="gap: 8px; justify-content: center; flex: 1;">
        <button class="pill" data-s="10">10Áßí</button>
        <button class="pill" data-s="20">20Áßí</button>
        <button class="pill" data-s="30">30Áßí</button>
        <button class="pill" data-s="60">1ÂàÜ</button>
        <button class="pill" data-s="300">5ÂàÜ</button>
      </div>

      <span class="timer-text" id="left">--:--</span>
    </div>

    <div class="row" style="margin-top: 24px;">
      <button class="btn" id="start" style="flex:2" disabled>Ê∫ñÂÇô‰∏≠...</button>
      <button class="btn ghost" id="stop" disabled style="flex:1">ÂÅúÊ≠¢</button>
    </div>
  </div>

  <div class="game-area">
    <div id="jelly-panel" class="bg-idle">
      <img id="jellyImg" src="ËÉåÊôØÊ∞¥ÊØç.png" alt="Ê∞¥ÊØç"
           onerror="this.style.display='none'; this.parentElement.innerText='(ÁîªÂÉè„Å™„Åó)'">
    </div>

    <div id="live-monitor">
      <div class="live-label">POSTURE STATUS</div>
      <div id="live-status-text" class="live-status-big st-idle">READY</div>

      <div class="live-score-box">
        <span>ÁèæÂú®„ÅÆÂßøÂã¢Áä∂ÊÖã</span>
        <span id="live-score-val" style="font-size: 32px;">--</span>
      </div>

      <div id="combo-area">
        <span id="combo-num" class="combo-num">0</span><span class="combo-lbl">STREAK</span>
      </div>

      <div class="hint-text">„Ç´„É°„É©„ÇíË¶ã„Å¶ËÉåÁ≠ã„Çí‰º∏„Å∞„Åù„ÅÜ</div>
    </div>
  </div>
</div>

<div id="goal-modal" class="modal-overlay" aria-hidden="true">
  <div class="modal-card">
    <div class="mini-title">ÁõÆÊ®ô„ÇíË®≠ÂÆö</div>
    <p class="mini-desc">
      ‰ªäÊó•„ÅÆÁõÆÊ®ôÔºàÂßøÂã¢Áä∂ÊÖãÔºâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
      ‚Äª ÊàêÁ∏æ„Åß„ÅØ„Å™„Åè„ÄÅÁõÆÂÆâ„ÅÆÁõÆÊ®ô„Åß„Åô„ÄÇ
    </p>

    <div class="target-buttons">
      <button class="target-btn" data-val="60">60%</button>
      <button class="target-btn" data-val="70">70%</button>
      <button class="target-btn" data-val="80">80%</button>
      <button class="target-btn" data-val="90">90%</button>
    </div>

    <div class="slider-label">SLIDE</div>
    <input id="targetSlider" type="range" min="50" max="95" step="1" value="80"/>

    <div class="modal-actions">
      <button class="modal-btn cancel" id="goal-cancel">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="modal-btn save" id="goal-save">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<div id="reward-modal" class="modal-overlay">
  <div class="modal-card">
    <div class="icon-wrapper">
      <div class="modal-glow-bg"></div>
      <div id="m-icon" class="modal-icon">üåü</div>
    </div>

    <div id="m-medal-name" class="medal-name">--</div>
    <p id="m-msg" class="modal-msg">...</p>

    <div class="reward-summary">
      <div class="reward-pill rp-score">
        <span class="rp-label">„Ç≠„Éº„ÉóÁéá</span>
        <span class="rp-val" id="m-final-score">0%</span>
      </div>
      <div class="reward-pill rp-gem">
        <span class="rp-label">ÊúÄÂ§ß„Çπ„Éà„É™„Éº„ÇØ</span>
        <span class="rp-val" id="m-max-combo">0</span>
      </div>
    </div>

    <button class="modal-btn primary" id="to-analysis-btn">ÂàÜÊûê„ÇíË¶ã„Çã</button>
  </div>
</div>

<div id="analysis-modal" class="modal-overlay">
  <div class="modal-card">
    <h2 class="modal-title">ÂàÜÊûê„É¨„Éù„Éº„Éà</h2>

    <div class="analysis-content">
      <canvas id="pie" width="180" height="180" style="filter: drop-shadow(0 4px 0 rgba(0,0,0,0.2));"></canvas>
      <ul>
        <li id="li-good-el" class="li-good">
          <span>‚úÖ Ê≠£„Åó„ÅÑÂßøÂã¢</span><strong id="res-good" class="val-good">0%</strong>
        </li>
        <li id="li-bad-el" class="li-bad">
          <span>‚ö†Ô∏è Áå´ËÉå (Ââç)</span><strong id="res-bad" class="val-bad">0%</strong>
        </li>
        <li id="li-lean-el" class="li-lean">
          <span>‚ö†Ô∏è „ÇÇ„Åü„Çå (Âæå)</span><strong id="res-lean" class="val-lean">0%</strong>
        </li>
      </ul>
      <div class="advice-box">
        <span class="advice-title">üí° „Ç¢„Éâ„Éê„Ç§„Çπ</span>
        <p id="advice-text" class="advice-text">„Éá„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
      </div>
    </div>
    <div style="margin-top:24px; width:100%">
      <button class="modal-btn" id="close-all-btn">Èñâ„Åò„Çã</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8.3/dist/teachablemachine-pose.min.js"></script>

<script>
/* --- CONFIG & ASSETS --- */
const FILES = {
  start: '001_Ê∫ÄÂà•Ëä±‰∏∏Ôºà„Éé„Éº„Éû„É´Ôºâ_„Çπ„Çø„Éº„ÉàÔºÅÈ†ëÂºµ„Å£„Å¶‚Ä¶.wav',
  warnNekoze: '002_No.7Ôºà„Éé„Éº„Éû„É´Ôºâ_„Åª„Çâ„Åª„Çâ„ÄÅÁå´ËÉå„Çø„Çô„É°‚Ä¶.wav',
  warnLean: '003_No.7Ôºà„Éé„Éº„Éû„É´Ôºâ_„Åì„Çâ„Åì„Çâ„ÄÅ„ÇÇ„Åü„Çå„Å™‚Ä¶.wav',
};

const audioCache = {};
function preloadAudio() {
  for (const [key, url] of Object.entries(FILES)) {
    const a = new Audio();
    a.src = url;
    a.load();
    audioCache[key] = a;
  }
}
window.addEventListener('load', preloadAudio);

function playSound(key) {
  if(!voice.checked) return;
  const sound = audioCache[key];
  if(sound) {
    sound.currentTime = 0;
    sound.play().catch(e => console.log("Audio Error:", e));
  } else {
    new Audio(FILES[key]).play();
  }
}

/* --- GLOBAL VARS --- */
let st=null, sel=300, left=0;
let stats={good:0,bad:0,lean:0}, samples=0;
let combo=0;
let maxCombo=0;
let badStreak = 0;

/* Goal Logic Variables */
let targetGoal = 80; // default target %
let lastCurrentPct = 0;

const ov=document.getElementById('overlay'), ctx=ov.getContext('2d');
const loaderOverlay=document.getElementById('loader-overlay');
const countOverlay=document.getElementById('countdown-overlay');
const countText=document.getElementById('countdown-text');
const leftEl=document.getElementById('left');

const calibOverlay=document.getElementById('calib-overlay');
const calibRing=document.getElementById('calib-ring');
const calibCheck=document.getElementById('calib-check');
const calibMsg=document.getElementById('calib-msg');

const liveStatus=document.getElementById('live-status-text');
const liveScoreVal=document.getElementById('live-score-val');
const comboArea=document.getElementById('combo-area');
const comboNum=document.getElementById('combo-num');

const jellyPanel=document.getElementById('jelly-panel');
const jellyImg=document.getElementById('jellyImg');

const voice=document.getElementById('t-voice');
const overlayT=document.getElementById('t-video');
const startBtn=document.getElementById('start');
const stopBtn=document.getElementById('stop');

const rewardModal=document.getElementById('reward-modal');
const analysisModal=document.getElementById('analysis-modal');
const mIcon=document.getElementById('m-icon'), mMedalName=document.getElementById('m-medal-name'), mMsg=document.getElementById('m-msg');
const mFinalScore=document.getElementById('m-final-score'), mMaxCombo=document.getElementById('m-max-combo');
const pie=document.getElementById('pie'), pctx=pie.getContext('2d');
const resGood=document.getElementById('res-good'), resBad=document.getElementById('res-bad'), resLean=document.getElementById('res-lean');
const adviceText=document.getElementById('advice-text');

/* Top bar elements */
const goalCard = document.getElementById('goalCard');
const goalTargetEl = document.getElementById('goalTarget');
const currentValueEl = document.getElementById('currentValue');
const goalFill = document.getElementById('goalFill');
const achieveText = document.getElementById('achieveText');
const reportBtn = document.getElementById('reportBtn');

/* Goal modal elements */
const goalModal = document.getElementById('goal-modal');
const targetSlider = document.getElementById('targetSlider');
const targetBtns = document.querySelectorAll('.target-btn');
const goalCancel = document.getElementById('goal-cancel');
const goalSave = document.getElementById('goal-save');


let currentGroup="idle";
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playTone(type) {
  if(!voice.checked) return;
  if(audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain); gain.connect(audioCtx.destination);
  const now = audioCtx.currentTime;

  if (type === 'good') {
    osc.type = 'sine';
    osc.frequency.setValueAtTime(500, now);
    osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
    gain.gain.setValueAtTime(0.1, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
    osc.start(now); osc.stop(now + 0.1);
  } else if (type === 'bad') {
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(150, now);
    osc.frequency.linearRampToValueAtTime(100, now + 0.3);
    gain.gain.setValueAtTime(0.1, now);
    gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
    osc.start(now); osc.stop(now + 0.3);
  } else if (type === 'beep') {
    osc.type = 'square';
    osc.frequency.setValueAtTime(880, now);
    gain.gain.setValueAtTime(0.05, now);
    gain.gain.linearRampToValueAtTime(0.01, now + 0.1);
    osc.start(now); osc.stop(now + 0.1);
  }
}

const TM_URL="https://teachablemachine.withgoogle.com/models/JnAXlXAWG/";
let model=null, webcamTM=null, tmReady=false, detecting=false, lastPoseType="idle";
const CLASS_MAP={"Class 1":"idle","Class 2":"good","Class 3":"forward","Class 4":"lean"};

/* ===== Goal UI helpers ===== */
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

function updateGoalUI(){
  // Update text
  goalTargetEl.textContent = targetGoal + "%";
  currentValueEl.textContent = lastCurrentPct + "%";
  
  // Update progress bar
  const ratio = targetGoal > 0 ? Math.min(lastCurrentPct / targetGoal, 1) : 0;
  goalFill.style.width = (ratio * 100) + "%";
  achieveText.textContent = Math.round(ratio * 100) + "%";
  
  // Update color state
  goalCard.classList.toggle("goal-achieved", lastCurrentPct >= targetGoal && samples > 0);
}

function syncSliderToBtns(val){
  targetBtns.forEach(btn => {
    btn.classList.toggle('active', Number(btn.dataset.val) === val);
  });
  targetSlider.value = val;
}

/* ===== Goal modal interactions ===== */
function openGoalModal(){
  goalModal.classList.add('show');
  goalModal.setAttribute('aria-hidden', 'false');
  syncSliderToBtns(targetGoal); // Sync current goal to modal
}
function closeGoalModal(){
  goalModal.classList.remove('show');
  goalModal.setAttribute('aria-hidden', 'true');
}

/* Goal card click */
goalCard.addEventListener('click', () => {
  openGoalModal();
});

/* Buttons Logic */
targetBtns.forEach(btn => {
  btn.onclick = () => {
    const val = Number(btn.dataset.val);
    syncSliderToBtns(val);
  }
});

/* Slider Logic */
targetSlider.addEventListener('input', () => {
  const v = Number(targetSlider.value);
  targetBtns.forEach(btn => btn.classList.remove('active')); // deselect buttons when sliding
});

/* Save / Cancel */
goalCancel.addEventListener('click', () => closeGoalModal());
goalSave.addEventListener('click', () => {
  targetGoal = Number(targetSlider.value);
  closeGoalModal();
  updateGoalUI();
});

/* Click outside to close */
goalModal.addEventListener('click', (e) => {
  if(e.target === goalModal) closeGoalModal();
});

/* Report button */
reportBtn.addEventListener('click', () => {
  if(samples <= 0){
    alert("„Åæ„Å†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÖà„Å´Ë®àÊ∏¨„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
    return;
  }
  analysisModal.classList.add('show');
  prepareAnalysis();
});

/* --- INITIALIZATION & CALIBRATION --- */
async function ensureTeachableMachine(){
  if(tmReady) return true;
  loaderOverlay.classList.add('active');
  try {
    model=await tmPose.load(TM_URL+"model.json",TM_URL+"metadata.json");
    webcamTM=new tmPose.Webcam(640,360,true);
    await webcamTM.setup(); await webcamTM.play();
    ov.width=640; ov.height=360;
    tmReady=true;
    loaderOverlay.classList.remove('active');
    startDetectLoop();
    startCalibration();
    return true;
  } catch (err) {
    loaderOverlay.classList.remove('active');
    alert("„Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\nError: " + err);
    resetButtons();
    return false;
  }
}

let calibScore = 0;
function startCalibration(){
  calibOverlay.classList.add('active');
  startBtn.textContent = "Ê∫ñÂÇô‰∏≠...";
  startBtn.disabled = true;

  const calibTimer = setInterval(() => {
    if(lastPoseType === 'good') {
      calibScore++;
      calibRing.classList.add('active');
      calibMsg.textContent = "„Åù„ÅÆ„Åæ„Åæ„Ç≠„Éº„Éó...";
    } else {
      calibScore = Math.max(0, calibScore - 1);
      calibRing.classList.remove('active');
      calibMsg.textContent = "ËÉåÁ≠ã„Çí‰º∏„Å∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
    }

    if(calibScore > 30){
      clearInterval(calibTimer);
      calibCheck.classList.add('show');
      calibMsg.textContent = "„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫ÜÔºÅ";
      setTimeout(() => {
        calibOverlay.classList.remove('active');
        startBtn.textContent = "ÈñãÂßã";
        startBtn.disabled = false;
      }, 1000);
    }
  }, 100);
}

function startDetectLoop(){ if(!detecting){ detecting=true; frame(); } }
async function frame(){
  if(!detecting) return;
  webcamTM.update(); await predictOnce();
  requestAnimationFrame(frame);
}
async function predictOnce(){
  if(!model||!webcamTM) return;
  const {pose,posenetOutput}=await model.estimatePose(webcamTM.canvas);
  const prediction=await model.predict(posenetOutput);
  let best=prediction[0];
  for(let p of prediction) if(p.probability>best.probability) best=p;
  lastPoseType=CLASS_MAP[best.className]||"idle";

  ctx.clearRect(0,0,ov.width,ov.height);
  if(overlayT.checked){
    ctx.save();
    ctx.drawImage(webcamTM.canvas,0,0,ov.width,ov.height);
    if(pose){
      tmPose.drawKeypoints(pose.keypoints,0.5,ctx);
      tmPose.drawSkeleton(pose.keypoints,0.5,ctx);
    }
    ctx.restore();
  } else {
    ctx.drawImage(webcamTM.canvas,0,0,ov.width,ov.height);
  }
}

function updateLeft(s){
  const m=String(Math.floor(s/60)).padStart(2,'0');
  const ss=String(s%60).padStart(2,'0');
  leftEl.textContent=`${m}:${ss}`;
}

function triggerFlash(){
  document.body.classList.remove('screen-flash');
  void document.body.offsetWidth;
  document.body.classList.add('screen-flash');
}

function switchGroup(group){
  if(currentGroup===group) return;
  currentGroup=group;
  jellyPanel.className = "";

  if(group==="good"){
    jellyImg.src = "Ê≠£„Åó„ÅÑÂßøÂã¢Ê∞¥ÊØç.png"; jellyPanel.classList.add("bg-good");
    liveStatus.textContent="Nice!"; liveStatus.className="live-status-big st-good";
  } else if(group==="forward"){
    jellyImg.src = "Áå´ËÉåÊ∞¥ÊØç.png"; jellyPanel.classList.add("bg-bad");
    liveStatus.textContent="Áå´ËÉå!"; liveStatus.className="live-status-big st-bad";
  } else if(group==="lean"){
    jellyImg.src = "Ê§ÖÂ≠ê„Å´„ÇÇ„Åü„Çå„ÇãÊ∞¥ÊØç.png"; jellyPanel.classList.add("bg-bad");
    liveStatus.textContent="ÂæåÂÇæ!"; liveStatus.className="live-status-big st-bad";
  } else {
    jellyImg.src = "ËÉåÊôØÊ∞¥ÊØç.png"; jellyPanel.classList.add("bg-idle");
    liveStatus.textContent="READY"; liveStatus.className="live-status-big st-idle";
  }
}

async function start(){
  if(st) return;

  const ok = await ensureTeachableMachine();
  if(!ok) return;

  startBtn.disabled = true; stopBtn.disabled = false;
  if(audioCtx.state === 'suspended') await audioCtx.resume();

  left=sel; updateLeft(left);
  samples=0; stats={good:0,bad:0,lean:0}; combo=0; maxCombo=0;
  badStreak = 0;
  liveScoreVal.textContent='--';
  comboArea.classList.remove('active');
  switchGroup("idle");

  // Reset top goal UI
  lastCurrentPct = 0;
  updateGoalUI();

  countOverlay.classList.add('active');
  let cnt = 3;
  countText.textContent = cnt;

  const countTimer = setInterval(()=>{
    cnt--;
    if(cnt > 0) {
      countText.textContent = cnt;
      countText.style.animation = 'none';
      countText.offsetHeight;
      countText.style.animation = null;
    } else {
      clearInterval(countTimer);
      countText.textContent = "START!";
      setTimeout(()=>{
        countOverlay.classList.remove('active');
        playSound('start');
        st=setInterval(tick,1000);
      }, 800);
    }
  }, 1000);
}

function animateValue(obj, start, end, duration, suffix="") {
  let startTimestamp = null;
  const step = (timestamp) => {
    if (!startTimestamp) startTimestamp = timestamp;
    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
    obj.textContent = Math.floor(progress * (end - start) + start) + suffix;
    if (progress < 1) window.requestAnimationFrame(step);
    else obj.textContent = end + suffix;
  };
  window.requestAnimationFrame(step);
}

function stop(){
  if(!st) return;
  clearInterval(st); st=null;
  resetButtons();

  const g = Math.round(stats.good/(samples||1)*100)||0;
  let icon='', medalText='', msg='', colorClass='', confettiCnt=0;
  let audioKey = '';

  if(g >= 80) {
    icon='üåü'; medalText='Lv.3 ÂßøÂã¢„Éû„Çπ„Çø„Éº'; colorClass='lv-master';
    msg='Á¥†Êô¥„Çâ„Åó„ÅÑÈõÜ‰∏≠Âäõ„Åß„ÅôÔºÅ„Åì„ÅÆË™øÂ≠ê„Åß„ÄåËâØ„ÅÑÂßøÂã¢„Äç„ÇíÁøíÊÖ£„Å´„Åó„Åæ„Åó„Çá„ÅÜÔºÅ';
    audioKey = 'resGold'; confettiCnt=150;
  } else if(g >= 60) {
    icon='üëç'; medalText='Lv.2 ‰∏äÈÅî‰∏≠'; colorClass='lv-stable';
    msg='ËâØ„ÅÑ„Éö„Éº„Çπ„Åß„ÅôÔºÅ„ÅÇ„Å®Â∞ë„Åó„Åß„Éû„Çπ„Çø„Éº„É¨„Éô„É´„ÄÇËÉåÁ≠ã„ÇíÊÑèË≠ò„Åó„Å¶Á∂ö„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ';
    audioKey = 'resSilver'; confettiCnt=80;
  } else if(g >= 40) {
    icon='üå±'; medalText='Lv.1 Á∑¥Áøí‰∏≠'; colorClass='lv-novice';
    msg='„ÅäÁñ≤„ÇåÊßòÔºÅ„Åæ„Åö„ÅØ„Åì„ÅÆ„É¨„Éô„É´„Çí„Ç≠„Éº„Éó„Åô„Çã„Åì„Å®„Åã„ÇâÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇ';
    audioKey = 'resBronze'; confettiCnt=30;
  } else {
    icon='‚òï'; medalText='„Ç¶„Ç©„Éº„É†„Ç¢„ÉÉ„Éó'; colorClass='lv-warmup';
    msg='„Åæ„Åö„ÅØ„É™„É©„ÉÉ„ÇØ„Çπ„ÄÇÁÑ°ÁêÜ„Åõ„Åö„ÄÅÂ∞ë„Åó„Åö„Å§ÂßøÂã¢„ÇíÊ≠£„Åó„Å¶„ÅÑ„Åë„Å∞Â§ß‰∏àÂ§´„Åß„Åô„Çà„ÄÇ';
    audioKey = 'resPart'; confettiCnt=0;
  }

  if(voice.checked) {
    if(window.speechSynthesis.speaking) window.speechSynthesis.cancel();
    playSound(audioKey);
  }

  mIcon.textContent=icon;
  mMedalName.textContent=medalText;
  mMedalName.className="medal-name "+colorClass;
  mMsg.textContent=msg;

  mFinalScore.textContent = "0%";
  mMaxCombo.textContent = "0";

  rewardModal.classList.add('show');
  switchGroup("idle");

  setTimeout(() => {
    animateValue(mFinalScore, 0, g, 1500, "%");
    animateValue(mMaxCombo, 0, maxCombo, 1500);
  }, 100);

  if(confettiCnt>0) confetti({particleCount:confettiCnt, spread:70, origin:{y:0.6}});
}

function resetButtons(){ startBtn.disabled = false; stopBtn.disabled = true; }

function tick(){
  left--; updateLeft(left);
  if(left <= 3 && left > 0) playTone('beep');

  measure();
  handleSmartFeedback();

  if(left<=0) stop();
}

// SMART FEEDBACK
function handleSmartFeedback(){
  if (lastPoseType === 'forward' || lastPoseType === 'lean') {
    badStreak++;

    if (badStreak === 3) {
      playTone('bad');
    }

    if (badStreak === 5) {
      triggerFlash();
      playTone('bad');
    }

    if (badStreak >= 7 && (badStreak % 5 === 2)) {
      const key = lastPoseType === 'forward' ? 'warnNekoze' : 'warnLean';
      if(voice.checked && !window.speechSynthesis.speaking) playSound(key);
    }

  } else if (lastPoseType === 'good') {
    if (badStreak > 0) {
      if (badStreak >= 3) playTone('good');
      badStreak = 0;
    }
  }
}

function measure(){
  if(!tmReady || lastPoseType==='idle') return;

  if(lastPoseType==='good'){
    stats.good++; switchGroup("good");
    combo++;
    if(combo > maxCombo) maxCombo = combo;
    comboNum.textContent=combo; comboArea.classList.add('active');

    comboNum.classList.remove('combo-pop');
    void comboNum.offsetWidth;
    comboNum.classList.add('combo-pop');
  } else {
    if(lastPoseType==='forward'){ stats.bad++; switchGroup("forward"); }
    else if(lastPoseType==='lean'){ stats.lean++; switchGroup("lean"); }
    if(combo>0) combo=0;
    comboArea.classList.remove('active');
  }
  samples++;

  const g=Math.round(stats.good/samples*100)||0;
  
  // Update Tracking Score Display
  if(liveScoreVal.textContent !== g + " %") {
    liveScoreVal.textContent = g + " %";
    liveScoreVal.classList.remove('score-popping');
    void liveScoreVal.offsetWidth;
    liveScoreVal.classList.add('score-popping');
  }

  // Update Top Goal Display
  lastCurrentPct = g;
  updateGoalUI();
}

document.getElementById('to-analysis-btn').onclick=function(){
  rewardModal.classList.remove('show');
  setTimeout(()=>{ analysisModal.classList.add('show'); prepareAnalysis(); }, 200);
};
document.getElementById('close-all-btn').onclick=function(){ analysisModal.classList.remove('show'); };

function prepareAnalysis(){
  const g=Math.round(stats.good/(samples||1)*100)||0;
  const b=Math.round(stats.bad/(samples||1)*100)||0;
  const l=Math.max(0,100-g-b);

  document.getElementById('li-good-el').classList.remove('show');
  document.getElementById('li-bad-el').classList.remove('show');
  document.getElementById('li-lean-el').classList.remove('show');

  setTimeout(()=>document.getElementById('li-good-el').classList.add('show'), 100);
  setTimeout(()=>document.getElementById('li-bad-el').classList.add('show'), 300);
  setTimeout(()=>document.getElementById('li-lean-el').classList.add('show'), 500);

  animateValue(resGood, 0, g, 1000, "%");
  animateValue(resBad, 0, b, 1000, "%");
  animateValue(resLean, 0, l, 1000, "%");

  let advice="";
  if(g>80) advice="Ë¶ã‰∫ã„Åß„ÅôÔºÅ„Åì„ÅÆË™øÂ≠ê„Åß„ÄåÊ≠£„Åó„ÅÑÂ∫ß„ÇäÊñπ„Äç„ÇíÁ≠ãËÇâ„Å´Ë¶ö„ÅàËæº„Åæ„Åõ„Åæ„Åó„Çá„ÅÜ„ÄÇ";
  else if(b>l && b>20) advice="„ÄåÁå´ËÉå„Äç„ÅåÁõÆÁ´ã„Å°„Åæ„Åô„ÄÇÁîªÈù¢„ÇíË¶ó„ÅçËæº„Çì„Åß„ÅÑ„Åæ„Åõ„Çì„ÅãÔºüÈ°é„ÇíÂ∞ë„ÅóÂºï„Åç„ÄÅÁõÆÁ∑ö„ÇíÈ´ò„Åè„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ";
  else if(l>b && l>20) advice="„ÄåËÉå„ÇÇ„Åü„Çå„Äç„Å´È†º„Çä„Åô„Åé„Å¶„ÅÑ„Åæ„Åô„ÄÇ„ÅäËÖπ„Å´Â∞ë„ÅóÂäõ„ÇíÂÖ•„Çå„ÄÅÈ™®Áõ§„ÇíÁ´ã„Å¶„Çã„Ç§„É°„Éº„Ç∏„ÅßÂ∫ß„Å£„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
  else advice="ÂßøÂã¢„ÅåÂÆö„Åæ„Å£„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇË∂≥„ÅÆË£è„ÇíÂ∫ä„Å´„Åó„Å£„Åã„Çä„Å§„Åë„ÄÅ„É™„É©„ÉÉ„ÇØ„Çπ„Åó„Å¶Â∫ß„ÇäÁõ¥„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ";
  adviceText.textContent=advice;

  const colors=['#58CC02','#FFD900','#FF4B4B'];
  const targetAngles = [g, b, l].map(v => v/100 * Math.PI * 2);
  let startTime = null;
  const duration = 1000;

  function drawPieAnim(timestamp) {
    if (!startTime) startTime = timestamp;
    const progress = Math.min((timestamp - startTime) / duration, 1);
    const ease = 1 - Math.pow(1 - progress, 3);

    pctx.clearRect(0,0,180,180);
    let a = -Math.PI/2;

    targetAngles.forEach((target, i) => {
      const drawAmt = target * ease;
      if(drawAmt > 0) {
        pctx.beginPath(); pctx.moveTo(90,90);
        pctx.arc(90,90,80, a, a + drawAmt);
        pctx.closePath(); pctx.fillStyle=colors[i]; pctx.fill();
        a += drawAmt;
      }
    });

    pctx.fillStyle='#202F36';
    pctx.beginPath(); pctx.arc(90,90,50,0,Math.PI*2); pctx.fill();

    if (progress < 1) requestAnimationFrame(drawPieAnim);
  }
  requestAnimationFrame(drawPieAnim);
}

document.querySelectorAll('#duration .pill').forEach(b=>{
  b.onclick=()=>{
    sel=+b.dataset.s;
    document.querySelectorAll('#duration .pill').forEach(x=>x.dataset.active=0);
    b.dataset.active=1;
    updateLeft(sel);
  };
});
document.querySelector('#duration .pill[data-s="300"]').dataset.active=1;
updateLeft(300);

document.getElementById('start').onclick=start;
document.getElementById('stop').onclick=stop;

/* Initialize top goal UI + default target */
updateGoalUI();
syncSliderToBtns(targetGoal);

/* Init TeachableMachine on Load to enable Calibration */
ensureTeachableMachine();
</script>
</body>
</html>